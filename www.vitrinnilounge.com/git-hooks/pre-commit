#!/bin/bash
#
# Git Hook: Pre-Commit
# Verifica se h√° imagens/v√≠deos n√£o otimizados antes do commit
#

echo "üîç Verificando otimiza√ß√£o de arquivos..."

# Verificar se h√° JPG/PNG sem WebP correspondente
HAS_UNOPTIMIZED=0

for img in $(git diff --cached --name-only --diff-filter=A | grep -E '\.(jpg|jpeg|png)$'); do
    # Pular √≠cones e favicons
    if [[ "$img" =~ (favicon|icon|apple-icon|android-icon|ms-icon) ]]; then
        continue
    fi

    # Verificar se existe WebP correspondente
    webp="${img%.*}.webp"
    if [ ! -f "$webp" ]; then
        echo "‚ö†Ô∏è  AVISO: $img n√£o tem vers√£o WebP!"
        HAS_UNOPTIMIZED=1
    fi
done

# Verificar se h√° MP4 sem WebM correspondente
for video in $(git diff --cached --name-only --diff-filter=A | grep -E '\.mp4$'); do
    webm="${video%.*}.webm"
    if [ ! -f "$webm" ]; then
        echo "‚ö†Ô∏è  AVISO: $video n√£o tem vers√£o WebM!"
        HAS_UNOPTIMIZED=1
    fi
done

if [ $HAS_UNOPTIMIZED -eq 1 ]; then
    echo ""
    echo "‚ùå H√° arquivos n√£o otimizados!"
    echo ""
    echo "Execute para otimizar:"
    echo "  ./auto-optimize.sh"
    echo ""
    echo "Ou force o commit ignorando esta verifica√ß√£o:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "‚úÖ Todos os arquivos est√£o otimizados!"
exit 0
